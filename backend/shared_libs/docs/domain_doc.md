<!DOCTYPE html><html lang="fa" dir="rtl"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>مستند فنی معماری Core Domain</title><style>:root{--bg-color:#0f172a;--fg-color:#e2e8f0;--card-bg:#1e293b;--border-color:#334155;--accent-color:#38bdf8;--highlight-bg:#818cf8;--code-bg:#020617;--green:#4ade80;--yellow:#facc15;--red:#f87171;--purple:#c084fc;--orange:#fb923c;}@font-face{font-family:'Vazirmatn';src:url('https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css');font-weight:100 900;font-display:swap;}body{background-color:var(--bg-color);color:var(--fg-color);font-family:'Vazirmatn',-apple-system,BlinkMacSystemFont,"Segoe UI","Roboto",sans-serif;line-height:1.8;margin:0;padding:0;font-size:16px;}.container{max-width:980px;margin:2rem auto;padding:1rem 2rem;}header{text-align:center;margin-bottom:3rem;padding-bottom:2rem;border-bottom:1px solid var(--border-color);}h1{font-size:2.4rem;color:var(--accent-color);margin-bottom:0.5rem;}h2{font-size:1.8rem;color:var(--fg-color);border-bottom:2px solid var(--border-color);padding-bottom:0.75rem;margin-top:3rem;display:flex;align-items:center;gap:0.5rem;}h3{font-size:1.4rem;color:var(--purple);margin-top:2rem;}pre{background-color:var(--code-bg);border:1px solid var(--border-color);border-radius:8px;padding:1.2rem;overflow-x:auto;font-family:'Fira Code','Consolas',monospace;font-size:0.9rem;direction:ltr;text-align:left;margin:1rem 0;}.note{background-color:rgba(56,189,248,0.1);border-right:4px solid var(--accent-color);padding:1rem 1.5rem;margin:1.5rem 0;border-radius:6px;}.warning{background-color:rgba(251,146,60,0.1);border-right:4px solid var(--orange);padding:1rem 1.5rem;border-radius:6px;}.badge{display:inline-block;padding:0.2rem 0.6rem;border-radius:4px;font-size:0.8rem;font-weight:bold;margin-left:0.5rem;vertical-align:middle;}.badge-core{background:rgba(192,132,252,0.15);color:var(--purple);}.badge-repo{background:rgba(250,204,21,0.15);color:var(--yellow);}ul{list-style:none;padding:0;}li{position:relative;padding-right:1.5rem;margin-bottom:0.8rem;}li::before{content:"▹";position:absolute;right:0;color:var(--accent-color);font-weight:bold;}code{font-family:inherit;color:var(--yellow);background:rgba(255,255,255,0.05);padding:0.1rem 0.3rem;border-radius:3px;}footer{text-align:center;margin-top:4rem;padding-top:2rem;border-top:1px dashed var(--border-color);color:#64748b;}</style></head><body><div class="container"><header><h1>مستند فنی معماری Core Domain (نسخه ۲)</h1><p style="color:#94a3b8">راهنمای جامع زیرساخت مشترک، الگوهای طراحی و سرویس‌های پایه</p></header><section><h2>۱. فلسفه معماری جدید <span class="badge badge-core">Domain-Driven</span></h2><p>در نسخه جدید، معماری پروژه از حالت ساده به یک ساختار <strong>Domain-Driven Design (DDD)</strong> سبک تغییر یافته است. هدف اصلی، جداسازی کامل «منطق تجاری» (Business Logic) از «لایه نمایش» (Views/API) است. این یعنی قوانین هسته سیستم (مثل محاسبه قیمت چاپ یا ثبت سفارش) در پوشه <code>shared_libs</code> متمرکز شده‌اند و مستقل از اینکه درخواست از پنل ادمین می‌آید یا سایت مشتری، یکسان عمل می‌کنند.</p><div class="note"><strong>قانون طلایی:</strong> هیچ کوئری مستقیم دیتابیس یا منطق محاسباتی نباید در View نوشته شود. همه چیز باید از طریق Service و Repository انجام شود.</div></section><section><h2>۲. لایه داده (Repositories) <span class="badge badge-repo">Data Access</span></h2><p>تمام تعاملات با دیتابیس از طریق کلاس‌های Repository انجام می‌شود. ما یک کلاس مادر به نام <code>BaseRepository</code> داریم که متدهای استاندارد CRUD را فراهم می‌کند.</p><h3>ویژگی‌های کلیدی:</h3><ul><li><strong>جلوگیری از N+1 Query:</strong> استفاده سنگین از <code>select_related</code> و <code>prefetch_related</code> (مخصوصاً در محصول و سفارش).</li><li><strong>تراکنش‌های امن:</strong> استفاده از <code>select_for_update</code> برای عملیات مالی (Wallet) جهت جلوگیری از Race Condition.</li><li><strong>تمیزی کد:</strong> متدهای پیچیده مثل فیلتر کردن محصولات بر اساس ویژگی‌ها، پشت متدهای ساده‌ای مثل <code>get_product_detail</code> پنهان شده‌اند.</li></ul><pre><code># مثال استفاده از BaseRepository در سرویس
class ProductRepository(BaseRepository[Product]):
    def get_full_product(self, slug):
        return self.model.objects.select_related('category').prefetch_related(...).get(slug=slug)</code></pre></section><section><h2>۳. سرویس‌های دامین (Domain Services)</h2><p>اینجا قلب تپنده سیستم است. سرویس‌های دامین مسئول اجرای قوانین بیزنس هستند و هیچ وابستگی به `Request` یا `Response` وب ندارند.</p><h3>۳.۱ سرویس سبد خرید (CartDomainService)</h3><p>پیچیده‌ترین بخش سیستم که وظایف زیر را مدیریت می‌کند:</p><ul><li><strong>محاسبه قیمت:</strong> فراخوانی <code>ProductPriceCalculator</code> برای محاسبه قیمت بر اساس متریال، سایز و آپشن‌ها.</li><li><strong>مدیریت فایل‌ها:</strong> اتصال فایل‌های آپلود شده (CartItemUpload) به آیتم‌های سبد خرید.</li><li><strong>اعتبارسنجی:</strong> چک کردن موجودی، فعال بودن محصول و صحت ورودی‌ها.</li></ul><h3>۳.۲ سرویس سفارش (OrderDomainService)</h3><p>مسئول تبدیل «سبد خرید» به «سفارش نهایی» است. این عملیات به صورت <strong>Atomic Transaction</strong> انجام می‌شود:</p><pre><code>@transaction.atomic
def checkout_cart(self, user, address):
    # ۱. ساخت هدر سفارش
    # ۲. انتقال آیتم‌ها از CartItem به OrderItem
    # ۳. انتقال مالکیت فایل‌ها
    # ۴. حذف سبد خرید
    pass</code></pre><h3>۳.۳ سرویس کیف پول (WalletDomainService)</h3><p>امن‌ترین بخش سیستم که عملیات واریز و برداشت را مدیریت می‌کند. این سرویس قبل از هر تغییری، رکورد کیف پول را قفل (Lock) می‌کند تا از همزمانی درخواست‌ها جلوگیری شود.</p></section><section><h2>۴. سرویس‌های زیرساختی (Infrastructure)</h2><p>این سرویس‌ها ابزارهایی هستند که توسط سایر بخش‌ها استفاده می‌شوند و لاجیک بیزنس خاصی ندارند.</p><h3>۴.۱ سرویس کش (CacheService)</h3><p>یک پوشش (Wrapper) روی سیستم کش جنگو که متدهای استاندارد <code>get</code>, <code>set</code>, <code>delete</code> را ارائه می‌دهد. این سرویس برای ذخیره موقت داده‌های سنگین (مثل لیست محصولات صفحه اول) استفاده می‌شود.</p><h3>۴.۲ سرویس ایمیل (EmailService)</h3><p>وظیفه تولید و ارسال ایمیل‌های سیستم را بر عهده دارد. این سرویس از سیستم تمپلیت جنگو برای تولید همزمان نسخه HTML و Text ایمیل استفاده می‌کند تا بالاترین نرخ تحویل (Delivery Rate) را تضمین کند.</p><pre><code>email_service.send(
    subject="خوش‌آمدید",
    template="emails/welcome.html",
    to="user@example.com"
)</code></pre></section><section><h2>۵. مدیریت خطاها (Exception Handling)</h2><p>برای اینکه لایه API بتواند خطاهای معنادار به کاربر نشان دهد، ما Exceptionهای اختصاصی تعریف کرده‌ایم:</p><ul><li><code>WalletNotFoundException</code>: وقتی کیف پول کاربر وجود ندارد.</li><li><code>InsufficientFundsException</code>: وقتی موجودی برای برداشت کافی نیست.</li><li><code>ProductNotActiveException</code>: وقتی محصول غیرفعال است.</li></ul><div class="warning"><strong>نکته مهم:</strong> سرویس‌ها هرگز نباید HTTP Response (مثل 404) برگردانند. آن‌ها فقط Exception پرتاب می‌کنند و وظیفه View است که آن را گرفته و به پاسخ مناسب تبدیل کند.</div></section></div><footer><p>تیم فنی پرینتو24 | مستندسازی نسخه ۲.۰ معماری تمیز</p></footer></body></html>